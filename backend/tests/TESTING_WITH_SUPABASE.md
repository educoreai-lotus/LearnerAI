# Testing with Real Supabase Database

## ‚ö†Ô∏è Important: Unit Tests vs Integration Tests

**Unit Tests (what you just ran):**
- Use **mocks** - no database interaction
- Fast, isolated, no side effects
- **Nothing is written to Supabase**

**Integration Tests (what you need for Supabase):**
- Use **real database** - actual Supabase connection
- Slower, but tests real behavior
- **Data is written to Supabase**

---

## üîç What the Unit Tests Simulate

The `skills-gap-processing.test.js` tests simulate this flow:

### Test 1: New Skills Gap Creation
**What it simulates:**
1. Company doesn't exist ‚Üí Creates company in `companies` table
2. Learner doesn't exist ‚Üí Creates learner in `learners` table  
3. Skills gap doesn't exist ‚Üí Creates skills gap in `skills_gap` table

**What would be in Supabase (if it were real):**

**`companies` table:**
```json
{
  "company_id": "company-456",
  "company_name": "TechCorp Inc.",
  "approval_policy": "auto",
  "decision_maker": null
}
```

**`learners` table:**
```json
{
  "user_id": "user-123",
  "company_id": "company-456",
  "company_name": "TechCorp Inc.",
  "user_name": "Alice Johnson"
}
```

**`skills_gap` table:**
```json
{
  "gap_id": "<auto-generated-uuid>",
  "user_id": "user-123",
  "company_id": "company-456",
  "company_name": "TechCorp Inc.",
  "user_name": "Alice Johnson",
  "competency_target_name": "JavaScript ES6+ Syntax",
  "skills_raw_data": {
    "Competency_Front_End_Development": ["MGS_React_Hooks_Advanced"]
  },
  "exam_status": "PASS"
}
```

### Test 2: Skills Gap Update
**What it simulates:**
- Existing skills gap found
- Filters `skills_raw_data` to keep only skills in new gap
- Updates the skills gap record

**What would change in Supabase:**
- `skills_gap.skills_raw_data` would be updated with filtered skills
- `exam_status` might be updated
- `company_name` and `user_name` might be updated

### Test 3: Learner Creation
**What it simulates:**
- Company exists
- Learner doesn't exist ‚Üí Creates learner
- Then creates skills gap

**What would be in Supabase:**
- New row in `learners` table
- New row in `skills_gap` table

---

## üß™ How to Test with Real Supabase

### Option 1: Use the API Endpoint (Recommended)

**1. Start your backend server:**
```bash
cd backend
npm start
```

**2. Send a POST request to the API:**

Using PowerShell:
```powershell
$body = @{
    user_id = "user-123"
    user_name = "Alice Johnson"
    company_id = "company-456"
    company_name = "TechCorp Inc."
    competency_name = "JavaScript ES6+ Syntax"
    status = "pass"
    gap = @{
        "Competency_Front_End_Development" = @("MGS_React_Hooks_Advanced")
    }
} | ConvertTo-Json -Depth 10

Invoke-RestMethod -Uri "http://localhost:5000/api/v1/skills-gaps" `
    -Method POST `
    -Body $body `
    -ContentType "application/json"
```

Using cURL:
```bash
curl -X POST http://localhost:5000/api/v1/skills-gaps \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "user-123",
    "user_name": "Alice Johnson",
    "company_id": "company-456",
    "company_name": "TechCorp Inc.",
    "competency_name": "JavaScript ES6+ Syntax",
    "status": "pass",
    "gap": {
      "Competency_Front_End_Development": ["MGS_React_Hooks_Advanced"]
    }
  }'
```

**3. Check Supabase Dashboard:**
- Go to your Supabase project
- Navigate to **Table Editor**
- Check these tables:
  - `companies` - Should have new company
  - `learners` - Should have new learner
  - `skills_gap` - Should have new skills gap

---

### Option 2: Use the Seed Endpoint

**1. Seed the database:**
```bash
curl -X POST http://localhost:5000/api/seed
```

**2. Check Supabase:**
- All tables should have mock data
- See `backend/src/utils/mockData.js` for what data is seeded

---

## üìä What to Check in Supabase

### After Running Test Scenario 1 (New Skills Gap)

**1. `companies` table:**
```sql
SELECT * FROM companies WHERE company_id = 'company-456';
```
- Should have 1 row
- `approval_policy` = 'auto'

**2. `learners` table:**
```sql
SELECT * FROM learners WHERE user_id = 'user-123';
```
- Should have 1 row
- `company_id` = 'company-456'
- `user_name` = 'Alice Johnson'

**3. `skills_gap` table:**
```sql
SELECT * FROM skills_gap 
WHERE user_id = 'user-123' 
AND competency_target_name = 'JavaScript ES6+ Syntax';
```
- Should have 1 row
- `skills_raw_data` should contain the gap data
- `exam_status` = 'PASS' (or 'pass' depending on your mapping)

---

### After Running Test Scenario 2 (Update Skills Gap)

**1. `skills_gap` table:**
```sql
SELECT skills_raw_data FROM skills_gap 
WHERE user_id = 'user-123' 
AND competency_target_name = 'JavaScript ES6+ Syntax';
```
- `skills_raw_data` should be **filtered** - only skills from new gap
- Old skills not in new gap should be removed

---

## üîÑ Testing Update Flow

**1. Create initial skills gap:**
```powershell
$body1 = @{
    user_id = "user-123"
    user_name = "Alice Johnson"
    company_id = "company-456"
    company_name = "TechCorp Inc."
    competency_name = "JavaScript ES6+ Syntax"
    status = "pass"
    gap = @{
        "Competency_Front_End_Development" = @(
            "MGS_React_Hooks_Advanced",
            "MGS_Flexbox_Grid_System",
            "MGS_Async_Await_Handling"
        )
    }
} | ConvertTo-Json -Depth 10

Invoke-RestMethod -Uri "http://localhost:5000/api/v1/skills-gaps" `
    -Method POST -Body $body1 -ContentType "application/json"
```

**2. Update with smaller gap (filters skills):**
```powershell
$body2 = @{
    user_id = "user-123"
    user_name = "Alice Johnson"
    company_id = "company-456"
    company_name = "TechCorp Inc."
    competency_name = "JavaScript ES6+ Syntax"
    status = "pass"
    gap = @{
        "Competency_Front_End_Development" = @("MGS_React_Hooks_Advanced")
    }
} | ConvertTo-Json -Depth 10

Invoke-RestMethod -Uri "http://localhost:5000/api/v1/skills-gaps" `
    -Method POST -Body $body2 -ContentType "application/json"
```

**3. Check Supabase:**
- `skills_raw_data` should now only contain `MGS_React_Hooks_Advanced`
- Other skills should be filtered out

---

## üßπ Cleanup

After testing, you can clean up:

**Delete test data:**
```sql
-- In Supabase SQL Editor
DELETE FROM skills_gap WHERE user_id = 'user-123';
DELETE FROM learners WHERE user_id = 'user-123';
DELETE FROM companies WHERE company_id = 'company-456';
```

Or use the seed delete endpoint:
```bash
curl -X DELETE http://localhost:5000/api/seed
```

---

## üìù Summary

**Unit Tests (what you ran):**
- ‚úÖ Fast, isolated
- ‚ùå No Supabase data
- ‚úÖ Use mocks

**Integration Tests (what you need):**
- ‚úÖ Real Supabase data
- ‚úÖ Tests actual behavior
- ‚ùå Requires running server
- ‚ùå Slower

**To see data in Supabase:**
1. Start backend server
2. Call API endpoint with POST request
3. Check Supabase Table Editor
4. Verify data matches expected structure

